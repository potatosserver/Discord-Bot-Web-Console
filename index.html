<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Discord Clone</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">
    <style>
        :root {
            --header-primary: #fff;
            --header-secondary: #b9bbbe;
            --text-normal: #dcddde;
            --text-muted: #72767d;
            --interactive-normal: #b9bbbe;
            --interactive-hover: #dcddde;
            --interactive-active: #fff;
            --background-primary: #36393f;
            --background-secondary: #2f3136;
            --background-secondary-alt: #292b2f;
            --background-tertiary: #202225;
            --background-floating: #18191c;
            --background-modifier-hover: rgba(79,84,92,0.16);
            --background-modifier-selected: rgba(79,84,92,0.32);
            --channeltextarea-background: #40444b;
            --brand-experiment: #5865f2;
            --brand-experiment-hover: #4752c4;
            --status-online: #3ba55c;
            --status-idle: #faa61a;
            --status-dnd: #ed4245;
            --status-offline: #747f8d;
            --easing-standard: cubic-bezier(0.2, 0.8, 0.2, 1);
            --easing-bounce: cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* --- 動畫定義 --- */
        @keyframes fadeScaleIn {
            from { opacity: 0; transform: scale(0.98) translateY(5px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes msgSlideIn {
            from { opacity: 0; transform: translateY(10px) scale(0.99); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes iconPop {
            0% { transform: scale(1); }
            50% { transform: scale(0.95); }
            100% { transform: scale(1); }
        }

        .anim-fade-scale { animation: fadeScaleIn 0.25s var(--easing-standard) forwards; }
        .stagger-item { opacity: 0; animation: slideInLeft 0.3s var(--easing-standard) forwards; }
        .stagger-item:nth-child(1) { animation-delay: 0.05s; }
        .stagger-item:nth-child(2) { animation-delay: 0.08s; }
        .stagger-item:nth-child(3) { animation-delay: 0.11s; }
        .stagger-item:nth-child(4) { animation-delay: 0.14s; }
        .stagger-item:nth-child(5) { animation-delay: 0.17s; }
        .stagger-item:nth-child(n+6) { animation-delay: 0.2s; }

        html, body {
            height: 100%; width: 100%; margin: 0; padding: 0;
            background: var(--background-tertiary);
            color: var(--text-normal);
            font-family: 'gg sans', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            overflow: hidden; font-size: 16px;
        }
        
        a { text-decoration: none; color: inherit; }
        
        .scroller { overflow-y: auto; overflow-x: hidden; min-height: 0; }
        .scroller::-webkit-scrollbar { width: 8px; background-color: #2e3338; }
        .scroller::-webkit-scrollbar-thumb { background-color: #202225; border-radius: 4px; }
        .scroller::-webkit-scrollbar-track { background-color: #2e3338; }

        .app-mount { display: flex; width: 100%; height: 100%; overflow: hidden; position: relative; }

        /* --- 1. 左側伺服器導航欄 --- */
        .sidebar-container { 
            display: flex; flex-shrink: 0; height: 100%; z-index: 100; 
            transition: transform 0.3s var(--easing-standard);
        }
        
        .guilds-nav { 
            width: 72px; background-color: var(--background-tertiary); 
            padding-top: 12px; display: flex; flex-direction: column; align-items: center; 
            flex-shrink: 0; height: 100%; overflow: hidden; 
        }
        
        .guilds-nav .scroller {
            width: 100%; display: flex; flex-direction: column; align-items: center;
            flex: 1; overflow-y: scroll; scrollbar-width: none;
        }
        .guilds-nav .scroller::-webkit-scrollbar { display: none; }

        .guilds-tree { list-style: none; padding: 0; margin: 0; width: 100%; display: flex; flex-direction: column; align-items: center; }
        .guild-list-item { margin-bottom: 8px; position: relative; width: 72px; display: flex; justify-content: center; flex-shrink: 0; }
        .guild-blob-item { width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; position: relative; }

        .guild-icon-wrapper { 
            width: 48px; height: 48px; border-radius: 50%; 
            background-color: var(--background-primary); color: var(--text-normal); 
            display: flex; align-items: center; justify-content: center; 
            overflow: hidden; cursor: pointer; 
            transition: border-radius 0.3s var(--easing-standard), background-color 0.3s, color 0.3s, transform 0.1s;
        }
        .guild-icon-wrapper:active { transform: translateY(1px); }
        .guild-icon-img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s; }
        
        .guild-blob-item:hover .guild-icon-wrapper { border-radius: 16px; background-color: var(--brand-experiment); color: #fff; }
        .guild-blob-item.active .guild-icon-wrapper { border-radius: 16px; background-color: var(--brand-experiment); color: #fff; animation: iconPop 0.3s var(--easing-bounce); }

        .guild-pill { 
            position: absolute; left: -12px; top: 0; bottom: 0; margin: auto; 
            width: 4px; height: 8px; border-radius: 0 4px 4px 0; 
            background-color: var(--header-primary); opacity: 0; 
            transition: height 0.2s var(--easing-standard), opacity 0.2s;
        }
        .guild-blob-item:hover .guild-pill { opacity: 1; height: 20px; }
        .guild-blob-item.active .guild-pill { opacity: 1; height: 40px; }
        .guild-separator { width: 32px; height: 2px; background-color: #35363c; margin-bottom: 8px; flex-shrink: 0; }

        /* --- 2. 頻道列表 --- */
        .sidebar-channels { width: 240px; background-color: var(--background-secondary); display: flex; flex-direction: column; position: relative; }
        .sidebar-header { 
            height: 48px; padding: 0 16px; display: flex; align-items: center; 
            box-shadow: 0 1px 0 rgba(4,4,5,0.2); font-weight: bold; color: var(--header-primary); 
            cursor: pointer; flex-shrink: 0; transition: background 0.2s; 
        }
        .sidebar-header:hover { background-color: rgba(79,84,92,0.16); }
        .guild-header-name { font-size: 16px; margin: 0; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        
        .channels-scroller { flex: 1; padding: 10px 8px; }
        .category-header { 
            padding-left: 2px; margin-bottom: 2px; color: var(--interactive-normal); 
            font-size: 12px; font-weight: 700; text-transform: uppercase; 
            display: flex; align-items: center; cursor: pointer; 
            opacity: 0; animation: slideInLeft 0.3s var(--easing-standard) forwards; 
        }
        .channel-item { margin: 1px 0; }
        .channel-link { 
            display: flex; align-items: center; padding: 6px 8px; border-radius: 4px; 
            color: var(--text-muted); font-size: 16px; font-weight: 500; cursor: pointer; 
            transition: background 0.15s, color 0.15s; 
        }
        .channel-link:hover { background-color: var(--background-modifier-hover); color: var(--interactive-hover); }
        .channel-item.active .channel-link { background-color: var(--background-modifier-selected); color: #fff; }
        .channel-symbol { color: #8e9297; margin-right: 6px; font-size: 20px; }

        /* --- 左下角使用者資訊區 (修正版) --- */
        .user-bar { background-color: var(--background-secondary-alt); height: 52px; padding: 0 8px; display: flex; align-items: center; flex-shrink: 0; }
        .user-avatar-wrapper { position: relative; margin-right: 8px; }
        .user-avatar-img { width: 32px; height: 32px; border-radius: 50%; display: block; background: #333; }
        
        /* 綠色狀態點 */
        .status-indicator {
            position: absolute;
            bottom: -2px;
            right: -2px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 3px solid var(--background-secondary-alt); /* 邊框與背景同色，製造切割效果 */
            background-color: var(--status-online);
            z-index: 10;
        }

        /* 資訊文字區：改為 Flex 讓名稱不換行 */
        .user-info-text { 
            flex: 1; overflow: hidden; margin-right: 4px; 
            display: flex; align-items: baseline; white-space: nowrap; 
        }
        .user-username { font-size: 14px; font-weight: 600; color: #fff; overflow: hidden; text-overflow: ellipsis; }
        .user-discriminator { font-size: 12px; color: #b9bbbe; margin-left: 2px; }

        /* --- 3. 主聊天區 --- */
        .chat-main { flex: 1; display: flex; flex-direction: column; background-color: var(--background-primary); min-width: 0; height: 100%; position: relative; }
        .chat-header { 
            height: 48px; padding: 0 16px; display: flex; align-items: center; 
            box-shadow: 0 1px 0 rgba(4,4,5,0.02), 0 1px 3px rgba(4,4,5,0.06); 
            flex-shrink: 0; color: var(--header-primary); z-index: 10; 
        }
        .chat-header-title { font-weight: 700; font-size: 16px; margin-right: 12px; color: #fff; }
        .chat-header-topic { color: #b9bbbe; font-size: 14px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; margin-left: 12px; border-left: 1px solid #42454a; padding-left: 12px; }
        .mobile-menu-btn { display: none; margin-right: 16px; color: #b9bbbe; cursor: pointer; transition: color 0.2s; }
        .mobile-menu-btn:hover { color: #fff; }
        .home-mobile-header { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 48px; padding: 0 16px; box-sizing: border-box; align-items: center; z-index: 5; }

        .chat-body { flex: 1; display: flex; overflow: hidden; position: relative; }
        .messages-wrapper { flex: 1; display: flex; flex-direction: column; min-width: 0; }
        .msg-list { flex: 1; padding-bottom: 20px; display: flex; flex-direction: column; overflow-y: auto; scroll-behavior: smooth; }
        
        .msg-container { 
            padding: 2px 16px; margin-top: 17px; display: flex; 
            opacity: 0; animation: msgSlideIn 0.3s var(--easing-standard) forwards; 
        }
        .msg-container:hover { background-color: rgba(4,4,5,0.07); }
        .msg-avatar { width: 40px; height: 40px; border-radius: 50%; margin-right: 16px; margin-top: 2px; cursor: pointer; transition: opacity 0.2s; }
        .msg-avatar:hover { opacity: 0.8; }
        .msg-content { flex: 1; min-width: 0; }
        .msg-header { display: flex; align-items: center; margin-bottom: 2px; }
        .msg-author { font-size: 16px; font-weight: 500; color: #fff; margin-right: 4px; }
        .bot-tag { background: #5865f2; color: #fff; font-size: 10px; padding: 1px 4px; border-radius: 3px; margin-right: 4px; vertical-align: middle; height: 15px; display: inline-flex; align-items: center; }
        .msg-timestamp { font-size: 12px; color: #72767d; margin-left: 4px; }
        .msg-text { font-size: 16px; color: #dcddde; line-height: 1.375rem; white-space: pre-wrap; word-wrap: break-word; }
        .msg-text code { background: #2f3136; padding: 2px; border-radius: 3px; font-family: Consolas, monospace; }
        .msg-text pre { background: #2f3136; padding: 8px; border-radius: 4px; border: 1px solid #202225; margin-top: 6px; max-width: 90%; overflow-x: auto; }
        .msg-text a { color: #00b0f4; }
        .msg-text img { max-width: 100%; height: auto; border-radius: 4px; display: block; margin-top: 4px;}

        #send-form { padding: 0 16px 24px 16px; flex-shrink: 0; background-color: var(--background-primary); }
        .channel-textarea { background-color: var(--channeltextarea-background); border-radius: 8px; }
        .channel-textarea-inner { display: flex; align-items: flex-start; padding: 10px 0; }
        .attach-button { background: none; border: none; cursor: pointer; color: #b9bbbe; padding: 0 16px; display: flex; align-items: center; justify-content: center; height: 24px; transition: color 0.2s; }
        .attach-button:hover { color: #dcddde; }
        #msg-content { flex: 1; background: transparent; border: none; color: #dcddde; font-size: 16px; resize: none; outline: none; max-height: 50vh; line-height: 1.375rem; height: 22px; font-family: inherit; }

        /* --- 4. 成員列表 --- */
        .members-sidebar { 
            width: 240px; background-color: var(--background-secondary); 
            display: flex; flex-direction: column; flex-shrink: 0; height: 100%; 
            border-left: 1px solid var(--background-tertiary); overflow-y: auto; 
            transition: width 0.3s var(--easing-standard), opacity 0.3s; 
        }
        .members-sidebar.hidden { width: 0; opacity: 0; border: none; }
        
        .member-category { 
            padding: 24px 16px 8px 16px; color: #96989d; font-size: 12px; font-weight: 700; 
            text-transform: uppercase; letter-spacing: 0.02em; 
            opacity: 0; animation: slideInLeft 0.3s var(--easing-standard) forwards; 
        }
        .member-item { 
            display: flex; align-items: center; padding: 6px 8px; margin: 1px 8px; 
            border-radius: 4px; cursor: pointer; opacity: 0; transition: background 0.1s; 
        }
        .member-item:hover { background-color: var(--background-modifier-hover); }
        .member-item.offline { opacity: 0.3; }
        .member-item.stagger-item.offline { animation-name: slideInLeftOffline; }
        @keyframes slideInLeftOffline { from { opacity: 0; transform: translateX(-10px); } to { opacity: 0.3; transform: translateX(0); } }

        .member-avatar-container { position: relative; margin-right: 12px; width: 32px; height: 32px; flex-shrink: 0; }
        .member-avatar { width: 32px; height: 32px; border-radius: 50%; }
        .member-status { position: absolute; bottom: -2px; right: -2px; width: 10px; height: 10px; border-radius: 50%; border: 3px solid var(--background-secondary); }
        .status-online { background-color: #3ba55c; }
        .status-idle { background-color: #faa61a; }
        .status-dnd { background-color: #ed4245; }
        .member-name { font-weight: 500; font-size: 16px; color: #fff; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }

        .attachments-grid { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
        .attachment-card img { max-height: 300px; max-width: 100%; border-radius: 4px; }
        .file-card { background: var(--background-secondary); padding: 10px; border: 1px solid #202225; display: flex; align-items: center; border-radius: 5px; }
        .file-icon { width: 40px; height: 40px; border-radius: 5px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #fff; margin-right: 10px; font-size: 10px; }
        .file-type-other { background-color: #72767d; }
        .embeds-container { margin-top: 8px; }
        .embed-wrapper { display: flex; background: #2f3136; border-radius: 4px; max-width: 520px; overflow: hidden; margin-bottom: 8px; border: 1px solid #202225; }
        .embed-sidebar { width: 4px; background-color: #202225; flex-shrink: 0; }
        .embed-content { padding: 8px 16px 16px 12px; flex: 1; min-width: 0; }
        .embed-title { font-weight: 600; font-size: 16px; margin-bottom: 8px; color: #fff; }
        .embed-desc { font-size: 14px; color: #dcddde; margin-bottom: 8px; white-space: pre-wrap; }
        .embed-image { max-width: 100%; height: auto; border-radius: 4px; display: block; margin-top: 8px; }
        
        /* 手機適配 */
        .mobile-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 90; transition: opacity 0.3s ease; opacity: 0; pointer-events: none; }
        .mobile-overlay.active { display: block; opacity: 1; pointer-events: auto; }

        @media (max-width: 768px) {
            .mobile-menu-btn { display: block; }
            .home-mobile-header { display: flex; }
            .sidebar-channels { width: 100%; max-width: 280px; }
            .sidebar-container { position: absolute; top: 0; left: 0; height: 100%; transform: translateX(-100%); }
            .sidebar-container.open { transform: translateX(0); }
            .members-sidebar { position: absolute; right: 0; top: 0; z-index: 100; box-shadow: -2px 0 5px rgba(0,0,0,0.5); }
            .members-sidebar.hidden { transform: translateX(100%); width: 240px; opacity: 1; }
            .members-sidebar:not(.hidden) { transform: translateX(0); }
        }

        /* Modal */
        .ip-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 999; display: flex; align-items: center; justify-content: center; }
        .ip-modal { background: #36393f; padding: 28px; border-radius: 5px; width: 440px; box-shadow: 0 0 10px rgba(0,0,0,0.5); text-align: center; }
        .ip-modal input { width: 100%; padding: 10px; background: #202225; border: 1px solid #202225; color: #dcddde; border-radius: 3px; margin: 20px 0; box-sizing: border-box; }
        .ip-modal button { background: #5865f2; color: #fff; padding: 10px 24px; border: none; border-radius: 3px; cursor: pointer; width: 100%; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.1/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
</head>
<body>
    <div id="ip-input-modal" class="ip-modal-overlay">
        <div class="ip-modal">
            <h2 style="color:#fff; margin-top:0;">連接到 Bot 後端</h2>
            <div style="color:#b9bbbe; font-size:14px;">請輸入後端 IP (例如 127.0.0.1:5000)</div>
            <input type="text" id="backend-ip-input" placeholder="127.0.0.1:5000" value="127.0.0.1:5000">
            <button id="connect-backend-btn">連接</button>
            <div id="ip-error-message" style="color:#ed4245; margin-top:10px; font-size:12px;"></div>
        </div>
    </div>

    <div class="mobile-overlay" id="mobile-overlay"></div>

    <div id="app-content" class="app-mount" style="display:none;">
        <div class="sidebar-container" id="sidebar-container">
            <nav class="guilds-nav">
                <div class="scroller">
                    <ul class="guilds-tree" id="guild-list-root"></ul>
                </div>
            </nav>
            <div class="sidebar-channels" id="channels-sidebar-root"></div>
        </div>

        <div class="chat-main">
            <div id="main-content-root" style="height: 100%; display: flex; flex-direction: column; position: relative;">
                <div class="home-mobile-header">
                     <div class="mobile-menu-btn" id="mobile-menu-trigger-home">
                        <svg width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"></path></svg>
                    </div>
                </div>
                
                <div class="anim-fade-scale" style="display:flex;align-items:center;justify-content:center;height:100%;flex-direction:column;color:#8e9297;">
                    <svg width="100" height="100" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-5.5-2.5l7.51-3.49L17.5 6.5 9.99 9.99 6.5 17.5zm5.5-6.6c.61 0 1.1.49 1.1 1.1s-.49 1.1-1.1 1.1-1.1-.49-1.1-1.1.49-1.1 1.1-1.1z"></path></svg>
                    <h3 style="color:#fff;">請從左側選擇伺服器</h3>
                </div>
            </div>
        </div>

        <div id="members-sidebar-wrapper">
            <div id="members-sidebar" class="members-sidebar hidden">
                <div id="members-list"></div>
            </div>
        </div>
    </div>

    <script>
        let BACKEND_BASE_URL = '';
        let socket = null;
        let isLoadingMessages = false;
        let isMembersVisible = false;

        let STATE = {
            activeGuildId: null,
            activeChannelId: null,
            currentUser: null,
            guilds: [],
            channels: []
        };

        marked.setOptions({ breaks: true, highlight: (code, lang) => hljs.highlight(code, { language: hljs.getLanguage(lang) ? lang : 'plaintext' }).value });

        function getCookie(n) { const v = document.cookie.match('(^|;) ?' + n + '=([^;]*)(;|$)'); return v ? v[2] : null; }
        function setCookie(n, v, d) { const date = new Date; date.setTime(date.getTime() + 24*60*60*1000*d); document.cookie = n + "=" + v + ";path=/;expires=" + date.toGMTString(); }

        document.addEventListener('DOMContentLoaded', () => {
            const saved = getCookie('backend_ip');
            if(saved) {
                let ip = normalizeIp(saved);
                BACKEND_BASE_URL = ip;
                checkConnection(ip);
            } else {
                showIpInputModal();
            }
        });

        function normalizeIp(ip) {
            ip = ip.trim();
            if (ip.endsWith('/')) ip = ip.slice(0, -1);
            if (!/^https?:\/\//i.test(ip)) {
                ip = (ip.includes('localhost') || ip.includes('127.0.0.1')) ? 'http://' + ip : 'https://' + ip;
            }
            return ip;
        }

        function showIpInputModal() {
            const modal = document.getElementById('ip-input-modal');
            const inp = document.getElementById('backend-ip-input');
            const btn = document.getElementById('connect-backend-btn');
            
            modal.style.display = 'flex';
            btn.onclick = () => {
                let ip = normalizeIp(inp.value);
                BACKEND_BASE_URL = ip;
                setCookie('backend_ip', ip.replace(/^https?:\/\//, ''), 365);
                checkConnection(ip);
            }
        }

        async function checkConnection(ip) {
            try {
                const r = await fetch(`${ip}/api/init`);
                if(r.ok) {
                    document.getElementById('ip-input-modal').style.display = 'none';
                    document.getElementById('app-content').style.display = 'flex';
                    const data = await r.json();
                    initApp(data);
                } else throw new Error();
            } catch(e) { 
                document.getElementById('ip-error-message').innerText = "連接失敗，請檢查 IP 或後端是否啟動"; 
                document.getElementById('ip-input-modal').style.display = 'flex';
            }
        }

        function initApp(initData) {
            STATE.currentUser = initData.user;
            STATE.guilds = initData.guilds;
            
            socket = io(BACKEND_BASE_URL);
            socket.on('new_message', (data) => {
                if (STATE.activeGuildId == data.guild_id && STATE.activeChannelId == data.channel_id) {
                    const msgList = document.getElementById('msg-list');
                    if (msgList) {
                        msgList.insertAdjacentHTML('beforeend', renderMsg(data));
                        processMessageContent();
                        msgList.scrollTop = msgList.scrollHeight;
                    }
                }
            });

            renderGuildList();
            renderEmptySidebar();
            setupGlobalEvents();

            // 手機版預設打開選單
            if (window.innerWidth <= 768) {
                toggleMobileSidebar(true);
            }
        }

        window.selectGuild = async function(guildId) {
            STATE.activeGuildId = guildId;
            try {
                renderGuildList(); 
                
                const channelSidebar = document.getElementById('channels-sidebar-root');
                channelSidebar.innerHTML = `<div style="display:flex;height:100%;align-items:center;justify-content:center;color:#b9bbbe;">載入中...</div>`;

                const r = await fetch(`${BACKEND_BASE_URL}/api/guild/${guildId}`);
                if (!r.ok) throw new Error('Failed to fetch guild');
                
                const data = await r.json();
                STATE.channels = data.channels;
                
                renderChannelSidebar(data.guild);
                
                if (STATE.channels.length > 0) {
                    selectChannel(STATE.channels[0].id);
                } else {
                    document.getElementById('main-content-root').innerHTML = `
                        <div class="home-mobile-header"><div class="mobile-menu-btn" id="mobile-menu-trigger-home"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"></path></svg></div></div>
                        <div class="anim-fade-scale" style='padding:20px;color:#fff;display:flex;align-items:center;justify-content:center;height:100%;'>此伺服器沒有可用的文字頻道。</div>`;
                }
            } catch(e) { console.error(e); }
        }

        window.selectChannel = async function(channelId) {
            STATE.activeChannelId = channelId;
            const channel = STATE.channels.find(c => c.id == channelId);
            if(!channel) return;

            document.querySelectorAll('.channel-item').forEach(el => el.classList.remove('active'));
            const activeItem = document.querySelector(`.channel-item[data-id="${channelId}"]`);
            if(activeItem) activeItem.classList.add('active');

            toggleMobileSidebar(false);

            const mainRoot = document.getElementById('main-content-root');
            mainRoot.innerHTML = '';
            
            renderChatInterface(channel);

            loadMessages(STATE.activeGuildId, channelId);
            loadMembers(STATE.activeGuildId, channelId);
        }

        async function loadMessages(gid, cid, before = null) {
            const msgList = document.getElementById('msg-list');
            if(!msgList) return;

            try {
                let url = `${BACKEND_BASE_URL}/api/guild/${gid}/channel/${cid}/messages`;
                if(before) url += `?before=${before}`;
                
                const r = await fetch(url);
                const data = await r.json();
                
                let html = '';
                data.messages.forEach(m => html += renderMsg(m));

                if (before) {
                    const prevHeight = msgList.scrollHeight;
                    msgList.insertAdjacentHTML('afterbegin', html);
                    msgList.scrollTop = msgList.scrollHeight - prevHeight;
                } else {
                    msgList.innerHTML = html;
                    msgList.scrollTop = msgList.scrollHeight;
                }
                processMessageContent();
            } catch(e) { 
                console.error(e);
                if(!before) msgList.innerHTML = `<div style="padding:20px; text-align:center; color:#ed4245;">無法載入訊息</div>`;
            }
        }

        async function loadMembers(gid, cid) {
            try {
                const r = await fetch(`${BACKEND_BASE_URL}/api/guild/${gid}/channel/${cid}/members`);
                const j = await r.json();
                renderMembersList(j.members);
            } catch(e) { console.error(e); }
        }

        function renderGuildList() {
            const root = document.getElementById('guild-list-root');
            let html = `
            <li class="guild-list-item">
                <div class="guild-blob-item ${!STATE.activeGuildId ? 'active' : ''}">
                    <div class="guild-pill"></div>
                    <a href="javascript:void(0)" onclick="resetHome()" class="guild-icon-wrapper">
                        <svg width="28" height="20" viewBox="0 0 28 20"><path fill="currentColor" d="M20.6644 2.15556C19.1467 1.44444 17.5244 0.928889 15.8222 0.666667C15.8089 0.657778 15.7911 0.675556 15.7822 0.688889C15.5822 1.05333 15.3644 1.53333 15.2133 1.90222C13.4044 1.63556 11.6044 1.63556 9.81333 1.90222C9.66222 1.52889 9.44 1.05333 9.24 0.684444C9.23111 0.675556 9.21333 0.657778 9.2 0.666667C7.49778 0.924444 5.87556 1.44 4.35556 2.15556C4.34222 2.16 4.33333 2.17333 4.32889 2.18667C1.24889 6.78222 0.404444 11.2667 0.817778 15.7111C0.822222 15.7289 0.835556 15.7422 0.853333 15.7556C2.88 17.24 4.84 18.1422 6.77333 18.7378C6.79556 18.7467 6.81778 18.7333 6.83111 18.7111C7.28889 18.0844 7.70222 17.4267 8.06667 16.7422C8.08 16.7156 8.06667 16.6844 8.04 16.6756C7.32444 16.4089 6.64 16.0889 5.98667 15.7289C5.93333 15.6978 5.92889 15.6222 5.98222 15.5822C6.12444 15.4756 6.26222 15.3644 6.39556 15.2533C6.41333 15.2356 6.44 15.2311 6.46222 15.24C10.2933 17 14.7333 17 18.5422 15.24C18.5644 15.2267 18.5867 15.2356 18.6089 15.2533C18.7467 15.3644 18.8844 15.4756 19.0267 15.5822C19.08 15.6222 19.0756 15.6978 19.0222 15.7289C18.3689 16.0844 17.6844 16.7156 16.9644 16.7378C16.9378 16.68 16.9244 16.7111 16.9378 16.7378C17.3022 17.4222 17.7156 18.08 18.1733 18.7067C18.1867 18.7333 18.2089 18.7422 18.2311 18.7333C20.1644 18.1378 22.1244 17.2356 24.1511 15.7511C24.1689 15.7378 24.1822 15.7244 24.1867 15.7067C24.6978 10.48 22.9556 6.04 20.6756 2.18222C20.6667 2.16889 20.6578 2.15556 20.6644 2.15556ZM8.68 12.8711C7.54667 12.8711 6.61333 11.8311 6.61333 10.5511C6.61333 9.27111 7.52889 8.23111 8.68 8.23111C9.84 8.23111 10.7733 9.27111 10.7556 10.5511C10.7556 11.8311 9.84 12.8711 8.68 12.8711ZM16.3244 12.8711C15.1911 12.8711 14.2578 11.8311 14.2578 10.5511C14.2578 9.27111 15.1733 8.23111 16.3244 8.23111C17.4844 8.23111 18.4178 9.27111 18.4 10.5511C18.4 11.8311 17.4844 12.8711 16.3244 12.8711Z"></path></svg>
                    </a>
                </div>
            </li>
            <li class="guild-separator"></li>`;
            
            STATE.guilds.forEach(g => {
                const isActive = STATE.activeGuildId == g.id ? 'active' : '';
                const icon = g.icon_url 
                    ? `<img src="${g.icon_url}" alt="${g.name}" class="guild-icon-img" />`
                    : `<span style="font-size:12px;font-weight:bold;">${g.name.substring(0,2)}</span>`;
                html += `
                <li class="guild-list-item">
                    <div class="guild-blob-item ${isActive}">
                        <div class="guild-pill"></div>
                        <a href="javascript:void(0)" onclick="selectGuild('${g.id}')" class="guild-icon-wrapper" title="${g.name}">
                            ${icon}
                        </a>
                    </div>
                </li>`;
            });
            root.innerHTML = html;
        }

        function renderChannelSidebar(guild) {
            const root = document.getElementById('channels-sidebar-root');
            let channelsHtml = '';
            STATE.channels.forEach((c, index) => {
                channelsHtml += `
                <li class="channel-item stagger-item">
                    <a href="javascript:void(0)" onclick="selectChannel('${c.id}')" class="channel-link">
                        <span class="channel-symbol">#</span>
                        <span class="channel-name">${c.name}</span>
                    </a>
                </li>`;
            });

            root.innerHTML = `
            <div class="sidebar-header"><h1 class="guild-header-name">${guild.name}</h1></div>
            <div class="channels-scroller scroller anim-fade-scale">
                <div class="category-header"><span style="font-size:10px; margin-right:4px;">&#9660;</span><span>文字頻道</span></div>
                <ul class="channel-list-tree" style="list-style:none;padding:0;margin:0;">${channelsHtml}</ul>
            </div>
            ${renderUserBar()}
            `;
        }

        function renderEmptySidebar() {
            document.getElementById('channels-sidebar-root').innerHTML = `
            <div class="sidebar-header"><button style="width:100%;text-align:left;background:#202225;color:#96989d;border:none;border-radius:4px;padding:6px;">尋找或開始對話</button></div>
            <div class="channels-scroller scroller anim-fade-scale">
                <div class="category-header" style="padding: 16px 8px 8px 16px;"><span>私人訊息 (即將開放)</span></div>
            </div>
            ${renderUserBar()}`;
        }

        function renderUserBar() {
            if(!STATE.currentUser) return '';
            return `
            <section class="user-bar">
                <div class="user-avatar-wrapper">
                   <img class="user-avatar-img" src="${STATE.currentUser.avatar_url}" alt="avatar">
                   <div class="status-indicator status-online"></div>
                </div>
                <div class="user-info-text">
                    <div class="user-username">${STATE.currentUser.username}</div>
                    <div class="user-discriminator">${STATE.currentUser.discriminator || ''}</div>
                </div>
            </section>`;
        }

        function renderChatInterface(channel) {
            const root = document.getElementById('main-content-root');
            root.innerHTML = `
            <div class="chat-header anim-fade-scale">
                <div class="mobile-menu-btn" id="mobile-menu-trigger">
                    <svg width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"></path></svg>
                </div>
                <span class="hashtag-symbol">#</span>
                <span class="chat-header-title">${channel.name}</span>
                ${channel.topic ? `<span class="chat-header-topic">${channel.topic}</span>` : ''}
                
                <div style="flex:1;"></div>
                <div style="cursor:pointer;color:#b9bbbe;" id="member-toggle-btn">
                     <svg width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" clip-rule="evenodd" d="M14 8.00598C14 10.211 12.206 12.006 10 12.006C7.795 12.006 6 10.211 6 8.00598C6 5.80098 7.795 4.00598 10 4.00598C12.206 4.00598 14 5.80098 14 8.00598ZM2 19.006C2 15.473 5.29 13.006 10 13.006C14.711 13.006 18 15.473 18 19.006V20.006H2V19.006Z"></path></svg>
                </div>
            </div>
            
            <div class="chat-body anim-fade-scale">
                <div class="messages-wrapper">
                    <div id="msg-list" class="msg-list scroller"></div>
                    <form id="send-form" enctype="multipart/form-data">
                        <div class="channel-textarea">
                            <div class="channel-textarea-inner">
                                <button type="button" id="file-btn" class="attach-button"><span>+</span><input type="file" name="file" id="msg-file" multiple style="display:none;"></button>
                                <textarea name="content" id="msg-content" placeholder="傳送訊息到 #${channel.name}" rows="1"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
            </div>`;
            
            const sidebar = document.getElementById('members-sidebar');
            if (isMembersVisible) sidebar.classList.remove('hidden');
            else sidebar.classList.add('hidden');
            
            setupChatEvents();
        }

        function renderMsg(m) {
            const botTag = m.is_bot ? '<span class="bot-tag">應用</span>' : '';
            let attHtml = '';
            let embedHtml = '';

            if(m.attachments && m.attachments.length > 0) {
                attHtml += '<div class="attachments-grid">';
                m.attachments.forEach(att => {
                    if(att.is_image) {
                        attHtml += `<a href="${att.url}" target="_blank" class="attachment-card"><img src="${att.url}" loading="lazy"></a>`;
                    } else {
                        const ext = att.filename.split('.').pop().toLowerCase();
                        let cls = 'file-type-other';
                        if(['pdf'].includes(ext)) cls = 'file-type-pdf';
                        else if(['zip','rar','7z'].includes(ext)) cls = 'file-type-archive';
                        attHtml += `<a href="${att.url}" target="_blank" class="attachment-card file-card"><div class="file-icon ${cls}">${ext.toUpperCase()}</div><div>${att.filename}</div></a>`;
                    }
                });
                attHtml += '</div>';
            }

            if(m.embeds && m.embeds.length > 0) {
                embedHtml += '<div class="embeds-container">';
                m.embeds.forEach(e => {
                    const img = e.image_url ? `<a href="${e.image_url}" target="_blank"><img class="embed-image" src="${e.image_url}" loading="lazy"></a>` : '';
                    const title = e.title ? `<div class="embed-title">${e.title}</div>` : '';
                    const desc = e.description ? `<div class="embed-desc">${e.description}</div>` : '';
                    embedHtml += `
                    <div class="embed-wrapper">
                        <div class="embed-sidebar"></div>
                        <div class="embed-content">${title}${desc}${img}</div>
                    </div>`;
                });
                embedHtml += '</div>';
            }

            return `
            <div class="msg-container" data-msgid="${m.id}">
                <div class="msg-avatar-wrapper"><img class="msg-avatar" src="${m.avatar_url}" loading="lazy"></div>
                <div class="msg-content">
                    <div class="msg-header">
                        <span class="msg-author">${m.author}</span>${botTag}
                        <span class="msg-timestamp" data-iso="${m.created_at}">${m.created_at}</span>
                    </div>
                    <div class="msg-text">${m.content}</div>
                    ${attHtml}
                    ${embedHtml}
                </div>
            </div>`;
        }

        function renderMembersList(members) {
            const list = document.getElementById('members-list');
            if(!list) return;

            const groups = {};
            const offlineGroup = [];

            members.forEach(m => {
                if (m.status === 'offline') {
                    offlineGroup.push(m);
                } else {
                    const role = m.highest_role_name || "線上";
                    if (!groups[role]) groups[role] = [];
                    groups[role].push(m);
                }
            });

            let html = '';
            
            Object.keys(groups).sort().forEach(role => {
                html += `<div class="member-category">${role} — ${groups[role].length}</div>`;
                groups[role].forEach(m => html += renderMemberItem(m, false));
            });

            if (offlineGroup.length > 0) {
                html += `<div class="member-category">離線 — ${offlineGroup.length}</div>`;
                offlineGroup.forEach(m => html += renderMemberItem(m, true));
            }

            list.innerHTML = html;
        }

        function renderMemberItem(m, isOffline) {
            const statusClass = `status-${m.status}`;
            const opacityClass = isOffline ? 'offline' : '';
            return `
            <div class="member-item stagger-item ${opacityClass}">
                <div class="member-avatar-container">
                    <img class="member-avatar" src="${m.avatar_url}" loading="lazy">
                    ${!isOffline ? `<div class="member-status ${statusClass}"></div>` : ''}
                </div>
                <div class="member-name" style="color:${m.color}">${m.display_name}</div>
            </div>`;
        }

        window.resetHome = function() {
            STATE.activeGuildId = null;
            STATE.activeChannelId = null;
            renderGuildList();
            renderEmptySidebar();
            
            document.getElementById('main-content-root').innerHTML = `
                <div class="home-mobile-header">
                    <div class="mobile-menu-btn" id="mobile-menu-trigger-home">
                        <svg width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"></path></svg>
                    </div>
                </div>
                <div class="anim-fade-scale" style="display:flex;align-items:center;justify-content:center;height:100%;flex-direction:column;color:#8e9297;">
                    <svg width="100" height="100" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-5.5-2.5l7.51-3.49L17.5 6.5 9.99 9.99 6.5 17.5zm5.5-6.6c.61 0 1.1.49 1.1 1.1s-.49 1.1-1.1 1.1-1.1-.49-1.1-1.1.49-1.1 1.1-1.1z"></path></svg>
                    <h3 style="color:#fff;">請從左側選擇伺服器</h3>
                </div>`;
            document.getElementById('members-list').innerHTML = '';
        }

        function setupGlobalEvents() {
            document.body.addEventListener('click', (e) => {
                if (e.target.closest('#mobile-menu-trigger') || e.target.closest('#mobile-menu-trigger-home')) {
                    toggleMobileSidebar(true);
                }
                
                if (e.target.id === 'mobile-overlay') {
                    toggleMobileSidebar(false);
                    isMembersVisible = false;
                    const sb = document.getElementById('members-sidebar');
                    if(sb) sb.classList.add('hidden');
                }
                const toggleBtn = e.target.closest('#member-toggle-btn');
                if (toggleBtn) {
                    isMembersVisible = !isMembersVisible;
                    const sb = document.getElementById('members-sidebar');
                    if(isMembersVisible) sb.classList.remove('hidden');
                    else sb.classList.add('hidden');
                    
                    if(isMembersVisible) toggleBtn.style.color = '#fff';
                    else toggleBtn.style.color = '#b9bbbe';
                }
            });
        }

        function setupChatEvents() {
            const form = document.getElementById('send-form');
            const msgList = document.getElementById('msg-list');
            const ta = document.getElementById('msg-content');
            const fb = document.getElementById('file-btn');

            if(fb) fb.onclick = () => document.getElementById('msg-file').click();

            msgList.addEventListener('scroll', () => {
                if (msgList.scrollTop === 0 && !isLoadingMessages && STATE.activeChannelId) {
                    isLoadingMessages = true;
                    const firstMsg = msgList.querySelector('.msg-container');
                    if (firstMsg) {
                         loadMessages(STATE.activeGuildId, STATE.activeChannelId, firstMsg.dataset.msgid)
                             .finally(() => isLoadingMessages = false);
                    } else isLoadingMessages = false;
                }
            }, { passive: true });

            ta.addEventListener('input', function(){
                this.style.height = 'auto'; this.style.height = this.scrollHeight + 'px';
                if(this.value==='') this.style.height = '22px';
            });
            
            ta.addEventListener('keydown', (e) => {
                if(e.key==='Enter' && !e.shiftKey) { e.preventDefault(); form.dispatchEvent(new Event('submit')); }
            });

            form.onsubmit = async (e) => {
                e.preventDefault();
                if(!ta.value.trim() && !document.getElementById('msg-file').value) return;
                const fd = new FormData(form);
                ta.value = ''; ta.style.height='22px';
                try {
                    await fetch(`${BACKEND_BASE_URL}/api/guild/${STATE.activeGuildId}/channel/${STATE.activeChannelId}/send`, {method:'POST', body:fd});
                } catch(err) { console.error(err); }
            };
        }

        function toggleMobileSidebar(open) {
            const sidebar = document.getElementById('sidebar-container');
            const overlay = document.getElementById('mobile-overlay');
            if (open) {
                sidebar.classList.add('open');
                overlay.classList.add('active');
            } else {
                sidebar.classList.remove('open');
                if (!isMembersVisible) overlay.classList.remove('active');
            }
        }

        function processMessageContent() {
            document.querySelectorAll('.msg-text').forEach(el => {
                if(!el.dataset.processed) {
                    const cleanHtml = DOMPurify.sanitize(marked.parse(el.textContent));
                    el.innerHTML = cleanHtml;
                    el.dataset.processed = "true";
                }
            });
            document.querySelectorAll('pre code').forEach((block) => hljs.highlightElement(block));
            document.querySelectorAll('.msg-timestamp').forEach(el => {
                const iso = el.getAttribute('data-iso');
                if(iso) el.textContent = formatTimestamp(iso);
            });
        }

        function formatTimestamp(isoStr) {
            const date = new Date(isoStr);
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1);
            const msgDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            const timeStr = date.toLocaleTimeString('zh-TW', { hour: 'numeric', minute: '2-digit', hour12: true });

            if (msgDate.getTime() === today.getTime()) return `今天 ${timeStr}`;
            else if (msgDate.getTime() === yesterday.getTime()) return `昨天 ${timeStr}`;
            else return `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()} ${timeStr}`;
        }
    </script>
</body>
</html>
