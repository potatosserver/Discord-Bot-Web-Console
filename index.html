<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Discord Clone Monitor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">
    <style>
        :root {
            --header-primary: #fff;
            --header-secondary: #b9bbbe;
            --text-normal: #dcddde;
            --text-muted: #72767d;
            --interactive-normal: #b9bbbe;
            --interactive-hover: #dcddde;
            --interactive-active: #fff;
            --background-primary: #36393f;
            --background-secondary: #2f3136;
            --background-secondary-alt: #292b2f;
            --background-tertiary: #202225;
            --background-floating: #18191c;
            --background-modifier-hover: rgba(79,84,92,0.16);
            --background-modifier-selected: rgba(79,84,92,0.32);
            --channeltextarea-background: #40444b;
            --brand-experiment: #5865f2;
            --brand-experiment-hover: #4752c4;
            --status-online: #3ba55c;
            --status-idle: #faa61a;
            --status-dnd: #ed4245;
            --status-offline: #747f8d;
            --easing-standard: cubic-bezier(0.2, 0.8, 0.2, 1);
            --easing-bounce: cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* --- 動畫定義 --- */
        @keyframes fadeScaleIn {
            from { opacity: 0; transform: scale(0.98) translateY(5px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes msgSlideIn {
            from { opacity: 0; transform: translateY(10px) scale(0.99); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes iconPop {
            0% { transform: scale(1); }
            50% { transform: scale(0.95); }
            100% { transform: scale(1); }
        }

        .anim-fade-scale { animation: fadeScaleIn 0.25s var(--easing-standard) forwards; }
        .stagger-item { opacity: 0; animation: slideInLeft 0.3s var(--easing-standard) forwards; }
        .stagger-item:nth-child(1) { animation-delay: 0.05s; }
        .stagger-item:nth-child(2) { animation-delay: 0.08s; }
        .stagger-item:nth-child(3) { animation-delay: 0.11s; }
        .stagger-item:nth-child(4) { animation-delay: 0.14s; }
        .stagger-item:nth-child(5) { animation-delay: 0.17s; }
        .stagger-item:nth-child(n+6) { animation-delay: 0.2s; }

        html, body {
            height: 100%; width: 100%; margin: 0; padding: 0;
            background: var(--background-tertiary);
            color: var(--text-normal);
            font-family: 'gg sans', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            overflow: hidden; font-size: 16px;
        }
        
        a { text-decoration: none; color: inherit; }
        
        .scroller { overflow-y: auto; overflow-x: hidden; min-height: 0; }
        .scroller::-webkit-scrollbar { width: 8px; background-color: #2e3338; }
        .scroller::-webkit-scrollbar-thumb { background-color: #202225; border-radius: 4px; }
        .scroller::-webkit-scrollbar-track { background-color: #2e3338; }

        .app-mount { display: flex; width: 100%; height: 100%; overflow: hidden; position: relative; }

        /* --- 1. 左側伺服器導航欄 --- */
        .sidebar-container { 
            display: flex; flex-shrink: 0; height: 100%; z-index: 100; 
            transition: transform 0.3s var(--easing-standard);
        }
        
        .guilds-nav { 
            width: 72px; background-color: var(--background-tertiary); 
            padding-top: 12px; display: flex; flex-direction: column; align-items: center; 
            flex-shrink: 0; height: 100%; overflow: hidden; 
        }
        
        .guilds-nav .scroller {
            width: 100%; display: flex; flex-direction: column; align-items: center;
            flex: 1; overflow-y: scroll; scrollbar-width: none;
        }
        .guilds-nav .scroller::-webkit-scrollbar { display: none; }

        .guilds-tree { list-style: none; padding: 0; margin: 0; width: 100%; display: flex; flex-direction: column; align-items: center; }
        .guild-list-item { margin-bottom: 8px; position: relative; width: 72px; display: flex; justify-content: center; flex-shrink: 0; }
        .guild-blob-item { width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; position: relative; }

        .guild-icon-wrapper { 
            width: 48px; height: 48px; border-radius: 50%; 
            background-color: var(--background-primary); color: var(--text-normal); 
            display: flex; align-items: center; justify-content: center; 
            overflow: hidden; cursor: pointer; 
            transition: border-radius 0.3s var(--easing-standard), background-color 0.3s, color 0.3s, transform 0.1s;
        }
        .guild-icon-wrapper:active { transform: translateY(1px); }
        .guild-icon-img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s; }
        
        .guild-blob-item:hover .guild-icon-wrapper { border-radius: 16px; background-color: var(--brand-experiment); color: #fff; }
        .guild-blob-item.active .guild-icon-wrapper { border-radius: 16px; background-color: var(--brand-experiment); color: #fff; animation: iconPop 0.3s var(--easing-bounce); }

        .guild-pill { 
            position: absolute; left: -12px; top: 0; bottom: 0; margin: auto; 
            width: 4px; height: 8px; border-radius: 0 4px 4px 0; 
            background-color: var(--header-primary); opacity: 0; 
            transition: height 0.2s var(--easing-standard), opacity 0.2s;
        }
        .guild-blob-item:hover .guild-pill { opacity: 1; height: 20px; }
        .guild-blob-item.active .guild-pill { opacity: 1; height: 40px; }
        .guild-separator { width: 32px; height: 2px; background-color: #35363c; margin-bottom: 8px; flex-shrink: 0; }

        /* --- 2. 頻道列表 --- */
        .sidebar-channels { width: 240px; background-color: var(--background-secondary); display: flex; flex-direction: column; position: relative; }
        .sidebar-header { 
            height: 48px; padding: 0 16px; display: flex; align-items: center; 
            box-shadow: 0 1px 0 rgba(4,4,5,0.2); font-weight: bold; color: var(--header-primary); 
            cursor: pointer; flex-shrink: 0; transition: background 0.2s; 
        }
        .sidebar-header:hover { background-color: rgba(79,84,92,0.16); }
        .guild-header-name { font-size: 16px; margin: 0; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        
        .channels-scroller { flex: 1; padding: 10px 8px; }
        .category-header { 
            padding-left: 2px; margin-bottom: 2px; color: var(--interactive-normal); 
            font-size: 12px; font-weight: 700; text-transform: uppercase; 
            display: flex; align-items: center; cursor: pointer; 
            opacity: 0; animation: slideInLeft 0.3s var(--easing-standard) forwards; 
        }
        .channel-item { margin: 1px 0; }
        .channel-link { 
            display: flex; align-items: center; padding: 6px 8px; border-radius: 4px; 
            color: var(--text-muted); font-size: 16px; font-weight: 500; cursor: pointer; 
            transition: background 0.15s, color 0.15s; 
        }
        .channel-link:hover { background-color: var(--background-modifier-hover); color: var(--interactive-hover); }
        .channel-item.active .channel-link { background-color: var(--background-modifier-selected); color: #fff; }
        .channel-symbol { color: #8e9297; margin-right: 6px; font-size: 20px; }

        /* 左下角使用者資訊區 */
        .user-bar { background-color: var(--background-secondary-alt); height: 52px; padding: 0 8px; display: flex; align-items: center; flex-shrink: 0; }
        .user-avatar-wrapper { position: relative; margin-right: 8px; }
        .user-avatar-img { width: 32px; height: 32px; border-radius: 50%; display: block; background: #333; }
        
        .status-indicator {
            position: absolute; bottom: -2px; right: -2px; width: 10px; height: 10px;
            border-radius: 50%; border: 3px solid var(--background-secondary-alt);
            background-color: var(--status-online); z-index: 10;
        }

        .user-info-text { flex: 1; overflow: hidden; margin-right: 4px; display: flex; align-items: baseline; white-space: nowrap; }
        .user-username { font-size: 14px; font-weight: 600; color: #fff; overflow: hidden; text-overflow: ellipsis; }
        .user-discriminator { font-size: 12px; color: #b9bbbe; margin-left: 2px; }

        /* --- 3. 主聊天區 --- */
        .chat-main { flex: 1; display: flex; flex-direction: column; background-color: var(--background-primary); min-width: 0; height: 100%; position: relative; }
        .chat-header { 
            height: 48px; padding: 0 16px; display: flex; align-items: center; 
            box-shadow: 0 1px 0 rgba(4,4,5,0.02), 0 1px 3px rgba(4,4,5,0.06); 
            flex-shrink: 0; color: var(--header-primary); z-index: 10; 
        }
        .chat-header-title { font-weight: 700; font-size: 16px; margin-right: 12px; color: #fff; }
        .chat-header-topic { color: #b9bbbe; font-size: 14px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; margin-left: 12px; border-left: 1px solid #42454a; padding-left: 12px; }
        .mobile-menu-btn { display: none; margin-right: 16px; color: #b9bbbe; cursor: pointer; transition: color 0.2s; }
        .mobile-menu-btn:hover { color: #fff; }
        .home-mobile-header { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 48px; padding: 0 16px; box-sizing: border-box; align-items: center; z-index: 5; }

        .chat-body { flex: 1; display: flex; overflow: hidden; position: relative; }
        .messages-wrapper { flex: 1; display: flex; flex-direction: column; min-width: 0; }
        .msg-list { flex: 1; padding-bottom: 20px; display: flex; flex-direction: column; overflow-y: auto; scroll-behavior: smooth; }
        
        .msg-container { 
            padding: 2px 16px; margin-top: 17px; display: flex; 
            opacity: 0; animation: msgSlideIn 0.3s var(--easing-standard) forwards; 
        }
        .msg-container:hover { background-color: rgba(4,4,5,0.07); }
        .msg-avatar { width: 40px; height: 40px; border-radius: 50%; margin-right: 16px; margin-top: 2px; cursor: pointer; transition: opacity 0.2s; }
        .msg-avatar:hover { opacity: 0.8; }
        .msg-content { flex: 1; min-width: 0; }
        .msg-header { display: flex; align-items: center; margin-bottom: 2px; }
        .msg-author { font-size: 16px; font-weight: 500; color: #fff; margin-right: 4px; }
        .bot-tag { background: #5865f2; color: #fff; font-size: 10px; padding: 1px 4px; border-radius: 3px; margin-right: 4px; vertical-align: middle; height: 15px; display: inline-flex; align-items: center; }
        .msg-timestamp { font-size: 12px; color: #72767d; margin-left: 4px; }
        .msg-text { font-size: 16px; color: #dcddde; line-height: 1.375rem; white-space: pre-wrap; word-wrap: break-word; }
        .msg-text code { background: #2f3136; padding: 2px; border-radius: 3px; font-family: Consolas, monospace; }
        .msg-text pre { background: #2f3136; padding: 8px; border-radius: 4px; border: 1px solid #202225; margin-top: 6px; max-width: 90%; overflow-x: auto; }
        .msg-text a { color: #00b0f4; }
        .msg-text img { max-width: 100%; height: auto; border-radius: 4px; display: block; margin-top: 4px;}

        #send-form { padding: 0 16px 24px 16px; flex-shrink: 0; background-color: var(--background-primary); }
        .channel-textarea { background-color: var(--channeltextarea-background); border-radius: 8px; }
        .channel-textarea-inner { display: flex; align-items: flex-start; padding: 10px 0; }
        .attach-button { background: none; border: none; cursor: pointer; color: #b9bbbe; padding: 0 16px; display: flex; align-items: center; justify-content: center; height: 24px; transition: color 0.2s; }
        .attach-button:hover { color: #dcddde; }
        #msg-content { flex: 1; background: transparent; border: none; color: #dcddde; font-size: 16px; resize: none; outline: none; max-height: 50vh; line-height: 1.375rem; height: 22px; font-family: inherit; }

        /* --- 4. 成員列表 --- */
        .members-sidebar { 
            width: 240px; background-color: var(--background-secondary); 
            display: flex; flex-direction: column; flex-shrink: 0; height: 100%; 
            border-left: 1px solid var(--background-tertiary); overflow-y: auto; 
            transition: width 0.3s var(--easing-standard), opacity 0.3s; 
        }
        .members-sidebar.hidden { width: 0; opacity: 0; border: none; }
        
        .member-category { 
            padding: 24px 16px 8px 16px; color: #96989d; font-size: 12px; font-weight: 700; 
            text-transform: uppercase; letter-spacing: 0.02em; 
            opacity: 0; animation: slideInLeft 0.3s var(--easing-standard) forwards; 
        }
        .member-item { 
            display: flex; align-items: center; padding: 6px 8px; margin: 1px 8px; 
            border-radius: 4px; cursor: pointer; opacity: 0; transition: background 0.1s; 
        }
        .member-item:hover { background-color: var(--background-modifier-hover); }
        .member-item.offline { opacity: 0.3; }
        .member-item.stagger-item.offline { animation-name: slideInLeftOffline; }
        @keyframes slideInLeftOffline { from { opacity: 0; transform: translateX(-10px); } to { opacity: 0.3; transform: translateX(0); } }

        .member-avatar-container { position: relative; margin-right: 12px; width: 32px; height: 32px; flex-shrink: 0; }
        .member-avatar { width: 32px; height: 32px; border-radius: 50%; }
        .member-status { position: absolute; bottom: -2px; right: -2px; width: 10px; height: 10px; border-radius: 50%; border: 3px solid var(--background-secondary); }
        .status-online { background-color: #3ba55c; }
        .status-idle { background-color: #faa61a; }
        .status-dnd { background-color: #ed4245; }
        .member-name { font-weight: 500; font-size: 16px; color: #fff; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }

        /* 檔案與Embed */
        .attachments-grid { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
        .attachment-card img { max-height: 300px; max-width: 100%; border-radius: 4px; }
        .file-card { background: var(--background-secondary); padding: 10px; border: 1px solid #202225; display: flex; align-items: center; border-radius: 5px; }
        .file-icon { width: 40px; height: 40px; border-radius: 5px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #fff; margin-right: 10px; font-size: 10px; }
        .file-type-other { background-color: #72767d; }
        .embeds-container { margin-top: 8px; }
        .embed-wrapper { display: flex; background: #2f3136; border-radius: 4px; max-width: 520px; overflow: hidden; margin-bottom: 8px; border: 1px solid #202225; }
        .embed-sidebar { width: 4px; background-color: #202225; flex-shrink: 0; }
        .embed-content { padding: 8px 16px 16px 12px; flex: 1; min-width: 0; }
        .embed-title { font-weight: 600; font-size: 16px; margin-bottom: 8px; color: #fff; }
        .embed-desc { font-size: 14px; color: #dcddde; margin-bottom: 8px; white-space: pre-wrap; }
        .embed-image { max-width: 100%; height: auto; border-radius: 4px; display: block; margin-top: 8px; }
        
        /* 手機適配 */
        .mobile-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 90; transition: opacity 0.3s ease; opacity: 0; pointer-events: none; }
        .mobile-overlay.active { display: block; opacity: 1; pointer-events: auto; }

        @media (max-width: 768px) {
            .mobile-menu-btn { display: block; }
            .home-mobile-header { display: flex; }
            .sidebar-channels { width: 100%; max-width: 280px; }
            .sidebar-container { position: absolute; top: 0; left: 0; height: 100%; transform: translateX(-100%); }
            .sidebar-container.open { transform: translateX(0); }
            .members-sidebar { position: absolute; right: 0; top: 0; z-index: 100; box-shadow: -2px 0 5px rgba(0,0,0,0.5); }
            .members-sidebar.hidden { transform: translateX(100%); width: 240px; opacity: 1; }
            .members-sidebar:not(.hidden) { transform: translateX(0); }
        }

        /* Modal */
        .ip-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 999; display: flex; align-items: center; justify-content: center; }
        .ip-modal { background: #36393f; padding: 28px; border-radius: 5px; width: 440px; box-shadow: 0 0 10px rgba(0,0,0,0.5); text-align: center; }
        .ip-modal input { width: 100%; padding: 10px; background: #202225; border: 1px solid #202225; color: #dcddde; border-radius: 3px; margin: 20px 0; box-sizing: border-box; }
        .ip-modal button { background: #5865f2; color: #fff; padding: 10px 24px; border: none; border-radius: 3px; cursor: pointer; width: 100%; transition: background 0.2s; }
        .ip-modal button:disabled { background: #4f545c; cursor: not-allowed; }
        .ip-modal button:hover:not(:disabled) { background: #4752c4; }

        /* --- 儀表板樣式 (系統監控) --- */
        .dashboard-container { padding: 40px; overflow-y: auto; height: 100%; box-sizing: border-box; }
        .dashboard-header { margin-bottom: 30px; border-bottom: 1px solid #4f545c; padding-bottom: 20px; }
        .dashboard-title { font-size: 24px; font-weight: bold; color: #fff; margin-bottom: 8px; }
        .dashboard-subtitle { font-size: 14px; color: #b9bbbe; }
        
        .dashboard-grid { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
            gap: 20px; max-width: 1200px; 
        }
        
        .stat-card { 
            background: #2f3136; border-radius: 8px; padding: 20px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: transform 0.2s; 
        }
        .stat-card:hover { transform: translateY(-2px); box-shadow: 0 5px 10px rgba(0,0,0,0.3); }
        
        .stat-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .stat-title { font-size: 12px; font-weight: 700; text-transform: uppercase; color: #b9bbbe; letter-spacing: 0.5px; }
        .stat-icon { color: #b9bbbe; opacity: 0.7; }
        
        .stat-value-big { font-size: 32px; font-weight: bold; color: #fff; margin-bottom: 5px; }
        .stat-value-sub { font-size: 14px; color: #72767d; margin-bottom: 15px; }
        
        .progress-track { width: 100%; height: 8px; background: #202225; border-radius: 4px; overflow: hidden; margin-top: 10px; }
        .progress-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease-out, background-color 0.5s; }
        
        .color-cpu { background-color: #ed4245; }
        .color-ram { background-color: #faa61a; }
        .color-disk { background-color: #3ba55c; }
        .color-net { background-color: #5865f2; }

        /* 網速監控美化與修復 */
        .net-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px; 
            margin-top: 15px; 
        }
        .net-item { 
            background: rgba(32, 34, 37, 0.6); 
            padding: 15px; 
            border-radius: 8px; 
            display: flex; 
            align-items: center; 
            border: 1px solid #202225;
            transition: background 0.2s;
            position: relative;
            overflow: hidden; 
            min-width: 0;
        }
        .net-item:hover { background: rgba(50, 53, 59, 0.6); }

        .net-icon-box {
            width: 40px; height: 40px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
            margin-right: 12px; flex-shrink: 0;
            background: rgba(255,255,255,0.05);
            font-size: 18px; font-weight: bold;
        }
        
        .net-info { flex: 1; min-width: 0; }
        .net-label { font-size: 11px; color: #b9bbbe; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .net-val { font-size: 16px; font-family: monospace; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .net-total { font-size: 11px; color: #72767d; margin-top: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* 顏色定義 */
        .text-up { color: #00b0f4; }
        .text-down { color: #3ba55c; }

        .system-info-list { list-style: none; padding: 0; margin: 0; }
        .system-info-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #40444b; font-size: 14px; }
        .system-info-item:last-child { border-bottom: none; }
        .sys-label { color: #b9bbbe; }
        .sys-val { color: #fff; font-weight: 500; }

    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.1/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
</head>
<body>
    <div id="ip-input-modal" class="ip-modal-overlay">
        <div class="ip-modal">
            <h2 style="color:#fff; margin-top:0;">連接到 Bot 後端</h2>
            <div style="color:#b9bbbe; font-size:14px;">請輸入後端 IP (例如 127.0.0.1:5000)</div>
            <input type="text" id="backend-ip-input" placeholder="127.0.0.1:5000" value="127.0.0.1:5000">
            <button id="connect-backend-btn">連接</button>
            <div id="ip-error-message" style="color:#ed4245; margin-top:10px; font-size:12px;"></div>
        </div>
    </div>

    <div class="mobile-overlay" id="mobile-overlay"></div>

    <div id="app-content" class="app-mount" style="display:none;">
        <div class="sidebar-container" id="sidebar-container">
            <nav class="guilds-nav">
                <div class="scroller">
                    <ul class="guilds-tree" id="guild-list-root"></ul>
                </div>
            </nav>
            <div class="sidebar-channels" id="channels-sidebar-root"></div>
        </div>

        <div class="chat-main">
            <div id="main-content-root" style="height: 100%; display: flex; flex-direction: column; position: relative;">
                <!-- 內容動態載入 -->
            </div>
        </div>

        <div id="members-sidebar-wrapper">
            <div id="members-sidebar" class="members-sidebar hidden">
                <div id="members-list"></div>
            </div>
        </div>
    </div>

    <script>
        let BACKEND_BASE_URL = '';
        let socket = null;
        let isLoadingMessages = false;
        let isMembersVisible = false;
        let monitorInterval = null; 

        // 記錄上次的網路流量數據與時間，用於計算即時速度
        let lastNetData = { sent: 0, recv: 0, time: 0 };

        let STATE = {
            activeGuildId: null,
            activeChannelId: null,
            currentUser: null,
            guilds: [],
            channels: []
        };

        marked.setOptions({ breaks: true, highlight: (code, lang) => hljs.highlight(code, { language: hljs.getLanguage(lang) ? lang : 'plaintext' }).value });

        function getCookie(n) { const v = document.cookie.match('(^|;) ?' + n + '=([^;]*)(;|$)'); return v ? v[2] : null; }
        function setCookie(n, v, d) { const date = new Date; date.setTime(date.getTime() + 24*60*60*1000*d); document.cookie = n + "=" + v + ";path=/;expires=" + date.toGMTString(); }

        document.addEventListener('DOMContentLoaded', () => {
            const saved = getCookie('backend_ip');
            if(saved) {
                let ip = normalizeIp(saved);
                BACKEND_BASE_URL = ip;
                checkConnection(ip);
            } else {
                showIpInputModal();
            }
        });

        function normalizeIp(ip) {
            ip = ip.trim();
            if (ip.endsWith('/')) ip = ip.slice(0, -1);
            if (!/^https?:\/\//i.test(ip)) {
                ip = (ip.includes('localhost') || ip.includes('127.0.0.1')) ? 'http://' + ip : 'https://' + ip;
            }
            return ip;
        }

        function showIpInputModal() {
            const modal = document.getElementById('ip-input-modal');
            const inp = document.getElementById('backend-ip-input');
            const btn = document.getElementById('connect-backend-btn');
            const errMsg = document.getElementById('ip-error-message');
            
            modal.style.display = 'flex';
            
            btn.onclick = async () => {
                errMsg.innerText = "";
                btn.disabled = true;
                btn.innerText = "連接中...";
                
                let ip = normalizeIp(inp.value);
                BACKEND_BASE_URL = ip;
                
                await checkConnection(ip);

                btn.disabled = false;
                btn.innerText = "連接";
            }
        }

        async function checkConnection(ip) {
            const errMsg = document.getElementById('ip-error-message');
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 3000);

                const r = await fetch(`${ip}/api/init`, { signal: controller.signal });
                clearTimeout(timeoutId);

                if(r.ok) {
                    setCookie('backend_ip', ip.replace(/^https?:\/\//, ''), 365);
                    document.getElementById('ip-input-modal').style.display = 'none';
                    document.getElementById('app-content').style.display = 'flex';
                    const data = await r.json();
                    initApp(data);
                } else throw new Error("Server error");
            } catch(e) { 
                console.error(e);
                let msg = "連接失敗，請檢查 IP 或後端是否啟動";
                if(e.name === 'AbortError') msg = "連接超時 (請檢查防火牆或 IP 是否正確)";
                errMsg.innerText = msg; 
                document.getElementById('ip-input-modal').style.display = 'flex';
            }
        }

        function initApp(initData) {
            STATE.currentUser = initData.user;
            STATE.guilds = initData.guilds;
            
            socket = io(BACKEND_BASE_URL);
            socket.on('new_message', (data) => {
                if (STATE.activeGuildId == data.guild_id && STATE.activeChannelId == data.channel_id) {
                    const msgList = document.getElementById('msg-list');
                    if (msgList) {
                        msgList.insertAdjacentHTML('beforeend', renderMsg(data));
                        processMessageContent();
                        msgList.scrollTop = msgList.scrollHeight;
                    }
                }
            });

            renderGuildList();
            renderEmptySidebar();
            
            resetHome();
            
            setupGlobalEvents();

            if (window.innerWidth <= 768) {
                toggleMobileSidebar(true);
            }
        }

        window.selectGuild = async function(guildId) {
            stopSystemMonitor();
            STATE.activeGuildId = guildId;
            try {
                renderGuildList(); 
                
                const channelSidebar = document.getElementById('channels-sidebar-root');
                channelSidebar.innerHTML = `<div style="display:flex;height:100%;align-items:center;justify-content:center;color:#b9bbbe;">載入中...</div>`;

                const r = await fetch(`${BACKEND_BASE_URL}/api/guild/${guildId}`);
                if (!r.ok) throw new Error('Failed to fetch guild');
                
                const data = await r.json();
                STATE.channels = data.channels;
                
                renderChannelSidebar(data.guild);
                
                if (STATE.channels.length > 0) {
                    selectChannel(STATE.channels[0].id);
                } else {
                    document.getElementById('main-content-root').innerHTML = `
                        <div class="home-mobile-header"><div class="mobile-menu-btn" id="mobile-menu-trigger-home"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"></path></svg></div></div>
                        <div class="anim-fade-scale" style='padding:20px;color:#fff;display:flex;align-items:center;justify-content:center;height:100%;'>此伺服器沒有可用的文字頻道。</div>`;
                }
            } catch(e) { console.error(e); }
        }

        window.selectChannel = async function(channelId) {
            STATE.activeChannelId = channelId;
            const channel = STATE.channels.find(c => c.id == channelId);
            if(!channel) return;

            document.querySelectorAll('.channel-item').forEach(el => el.classList.remove('active'));
            const activeItem = document.querySelector(`.channel-item[data-id="${channelId}"]`);
            if(activeItem) activeItem.classList.add('active');

            toggleMobileSidebar(false);

            const mainRoot = document.getElementById('main-content-root');
            mainRoot.innerHTML = '';
            
            renderChatInterface(channel);

            loadMessages(STATE.activeGuildId, channelId);
            loadMembers(STATE.activeGuildId, channelId);
        }

        window.resetHome = function() {
            STATE.activeGuildId = null;
            STATE.activeChannelId = null;
            renderGuildList();
            renderEmptySidebar();
            
            document.getElementById('members-sidebar').classList.add('hidden');
            renderSystemDashboard();
            startSystemMonitor();
        }

        // --- 系統監控儀表板 (修復版) ---

        function renderSystemDashboard() {
            const root = document.getElementById('main-content-root');
            root.innerHTML = `
                <div class="home-mobile-header">
                    <div class="mobile-menu-btn" id="mobile-menu-trigger-home">
                        <svg width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"></path></svg>
                    </div>
                </div>
                <div class="dashboard-container anim-fade-scale">
                    <div class="dashboard-header">
                        <div class="dashboard-title">系統狀態監控</div>
                        <div class="dashboard-subtitle">即時監測後端伺服器的資源使用情形</div>
                    </div>
                    <div class="dashboard-grid">
                        <!-- CPU -->
                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-title">CPU 使用率</span>
                                <svg class="stat-icon" width="20" height="20" viewBox="0 0 24 24"><path fill="currentColor" d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"></path></svg>
                            </div>
                            <div class="stat-value-big" id="val-cpu">0%</div>
                            <div class="stat-value-sub" id="val-cpu-freq">0 MHz</div>
                            <div class="progress-track"><div class="progress-fill color-cpu" id="bar-cpu" style="width: 0%"></div></div>
                        </div>

                        <!-- Memory -->
                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-title">記憶體</span>
                                <svg class="stat-icon" width="20" height="20" viewBox="0 0 24 24"><path fill="currentColor" d="M2 20h20v-4H2v4zm2-3h2v2H4v-2zM2 4v4h20V4H2zm4 3H4V5h2v2zm-4 7h20v-4H2v4zm2-3h2v2H4v-2z"></path></svg>
                            </div>
                            <div class="stat-value-big" id="val-mem-percent">0%</div>
                            <div class="stat-value-sub" id="val-mem-detail">0 GB / 0 GB</div>
                            <div class="progress-track"><div class="progress-fill color-ram" id="bar-mem" style="width: 0%"></div></div>
                        </div>

                        <!-- Disk -->
                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-title">硬碟空間 (/)</span>
                                <svg class="stat-icon" width="20" height="20" viewBox="0 0 24 24"><path fill="currentColor" d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"></path></svg>
                            </div>
                            <div class="stat-value-big" id="val-disk-percent">0%</div>
                            <div class="stat-value-sub" id="val-disk-detail">Free: 0 GB</div>
                            <div class="progress-track"><div class="progress-fill color-disk" id="bar-disk" style="width: 0%"></div></div>
                        </div>

                        <!-- Network (美化修復版) -->
                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-title">網路流量監控</span>
                                <svg class="stat-icon" width="20" height="20" viewBox="0 0 24 24"><path fill="currentColor" d="M7.77 6.76L6.23 5.48.82 12l5.41 6.52 1.54-1.28L3.42 12l4.35-5.24zM7 13h2v-2H7v2zm10-2h-2v2h2v-2zm-6 2h2v-2h-2v2zm6.77-7.52l-1.54 1.28L20.58 12l-4.35 5.24 1.54 1.28L23.18 12l-5.41-6.52z"></path></svg>
                            </div>
                            <div class="net-grid">
                                <!-- 上傳 -->
                                <div class="net-item">
                                    <div class="net-icon-box text-up" style="background: rgba(0, 176, 244, 0.1);">
                                        <svg width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M4 12l1.41 1.41L11 7.83V20h2V7.83l5.58 5.59L20 12l-8-8-8 8z"></path></svg>
                                    </div>
                                    <div class="net-info">
                                        <div class="net-label">Upload Speed</div>
                                        <div class="net-val text-up" id="val-net-up">0 KB/s</div>
                                        <div class="net-total" id="val-net-sent-total">Total: 0 MB</div>
                                    </div>
                                </div>
                                <!-- 下載 -->
                                <div class="net-item">
                                    <div class="net-icon-box text-down" style="background: rgba(59, 165, 92, 0.1);">
                                        <svg width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M20 12l-1.41-1.41L13 16.17V4h-2v12.17l-5.58-5.59L4 12l8 8 8-8z"></path></svg>
                                    </div>
                                    <div class="net-info">
                                        <div class="net-label">Download Speed</div>
                                        <div class="net-val text-down" id="val-net-down">0 KB/s</div>
                                        <div class="net-total" id="val-net-recv-total">Total: 0 MB</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- System Info -->
                        <div class="stat-card" style="grid-column: 1 / -1;">
                            <div class="stat-header">
                                <span class="stat-title">主機資訊</span>
                            </div>
                            <ul class="system-info-list">
                                <li class="system-info-item"><span class="sys-label">作業系統</span><span class="sys-val" id="val-os">Loading...</span></li>
                                <li class="system-info-item"><span class="sys-label">主機名稱</span><span class="sys-val" id="val-node">Loading...</span></li>
                                <li class="system-info-item"><span class="sys-label">運行時間</span><span class="sys-val" id="val-uptime">Loading...</span></li>
                                <li class="system-info-item"><span class="sys-label">處理器核心</span><span class="sys-val" id="val-cores">0 Cores</span></li>
                            </ul>
                        </div>
                    </div>
                </div>`;
        }

        function startSystemMonitor() {
            if (monitorInterval) clearInterval(monitorInterval);
            // 重置數據以免速度爆衝
            lastNetData = { sent: 0, recv: 0, time: 0 };
            
            const fetchStats = async () => {
                if (!document.getElementById('val-cpu')) return;
                try {
                    const r = await fetch(`${BACKEND_BASE_URL}/api/system_stats`);
                    if(r.ok) {
                        const data = await r.json();
                        updateDashboard(data);
                    }
                } catch(e) { console.error("Monitor error", e); }
            };

            fetchStats();
            monitorInterval = setInterval(fetchStats, 2000); 
        }

        function stopSystemMonitor() {
            if (monitorInterval) {
                clearInterval(monitorInterval);
                monitorInterval = null;
            }
        }

        function updateDashboard(data) {
            // CPU
            setText('val-cpu', data.cpu.percent + '%');
            setText('val-cpu-freq', parseInt(data.cpu.freq) + ' MHz');
            setBar('bar-cpu', data.cpu.percent);
            setText('val-cores', data.cpu.count + ' 核心');

            // RAM
            setText('val-mem-percent', data.memory.percent + '%');
            setText('val-mem-detail', `${formatBytes(data.memory.used)} / ${formatBytes(data.memory.total)}`);
            setBar('bar-mem', data.memory.percent);

            // Disk
            setText('val-disk-percent', data.disk.percent + '%');
            setText('val-disk-detail', `可用: ${formatBytes(data.disk.free)}`);
            setBar('bar-disk', data.disk.percent);

            // Net Speed Calculation
            const now = Date.now();
            let upSpeed = 0, downSpeed = 0;
            if (lastNetData.time !== 0) {
                const timeDiff = (now - lastNetData.time) / 1000; // 秒數差
                if (timeDiff > 0) {
                    upSpeed = (data.net.bytes_sent - lastNetData.sent) / timeDiff;
                    downSpeed = (data.net.bytes_recv - lastNetData.recv) / timeDiff;
                }
            }
            // 更新目前狀態
            lastNetData = { sent: data.net.bytes_sent, recv: data.net.bytes_recv, time: now };

            setText('val-net-up', formatBytes(upSpeed) + '/s');
            setText('val-net-down', formatBytes(downSpeed) + '/s');
            setText('val-net-sent-total', 'Total: ' + formatBytes(data.net.bytes_sent));
            setText('val-net-recv-total', 'Total: ' + formatBytes(data.net.bytes_recv));

            // System
            setText('val-os', `${data.system.system} ${data.system.release}`);
            setText('val-node', data.system.node);
            setText('val-uptime', formatUptime(data.system.uptime));
        }

        function setText(id, text) {
            const el = document.getElementById(id);
            if(el) el.innerText = text;
        }

        function setBar(id, percent) {
            const el = document.getElementById(id);
            if(el) el.style.width = percent + '%';
        }

        function formatBytes(bytes, decimals = 2) {
            if (!+bytes) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
        }

        function formatUptime(seconds) {
            const d = Math.floor(seconds / (3600*24));
            const h = Math.floor(seconds % (3600*24) / 3600);
            const m = Math.floor(seconds % 3600 / 60);
            const s = Math.floor(seconds % 60);
            
            let str = "";
            if(d > 0) str += `${d}天 `;
            if(h > 0) str += `${h}小時 `;
            str += `${m}分 ${s}秒`;
            return str;
        }

        // --- 聊天與成員列表邏輯 ---

        async function loadMessages(gid, cid, before = null) {
            const msgList = document.getElementById('msg-list');
            if(!msgList) return;

            try {
                let url = `${BACKEND_BASE_URL}/api/guild/${gid}/channel/${cid}/messages`;
                if(before) url += `?before=${before}`;
                
                const r = await fetch(url);
                const data = await r.json();
                
                let html = '';
                data.messages.forEach(m => html += renderMsg(m));

                if (before) {
                    const prevHeight = msgList.scrollHeight;
                    msgList.insertAdjacentHTML('afterbegin', html);
                    processMessageContent();
                    msgList.scrollTop = msgList.scrollHeight - prevHeight;
                } else {
                    msgList.innerHTML = html;
                    processMessageContent();
                    msgList.scrollTop = msgList.scrollHeight;
                    setTimeout(() => { msgList.scrollTop = msgList.scrollHeight; }, 10);
                }
            } catch(e) { 
                console.error(e);
                if(!before) msgList.innerHTML = `<div style="padding:20px; text-align:center; color:#ed4245;">無法載入訊息</div>`;
            }
        }

        async function loadMembers(gid, cid) {
            try {
                const r = await fetch(`${BACKEND_BASE_URL}/api/guild/${gid}/channel/${cid}/members`);
                const j = await r.json();
                renderMembersList(j.members);
            } catch(e) { console.error(e); }
        }

        function renderGuildList() {
            const root = document.getElementById('guild-list-root');
            let html = `
            <li class="guild-list-item">
                <div class="guild-blob-item ${!STATE.activeGuildId ? 'active' : ''}">
                    <div class="guild-pill"></div>
                    <a href="javascript:void(0)" onclick="resetHome()" class="guild-icon-wrapper">
                        <svg width="28" height="20" viewBox="0 0 28 20"><path fill="currentColor" d="M20.6644 2.15556C19.1467 1.44444 17.5244 0.928889 15.8222 0.666667C15.8089 0.657778 15.7911 0.675556 15.7822 0.688889C15.5822 1.05333 15.3644 1.53333 15.2133 1.90222C13.4044 1.63556 11.6044 1.63556 9.81333 1.90222C9.66222 1.52889 9.44 1.05333 9.24 0.684444C9.23111 0.675556 9.21333 0.657778 9.2 0.666667C7.49778 0.924444 5.87556 1.44 4.35556 2.15556C4.34222 2.16 4.33333 2.17333 4.32889 2.18667C1.24889 6.78222 0.404444 11.2667 0.817778 15.7111C0.822222 15.7289 0.835556 15.7422 0.853333 15.7556C2.88 17.24 4.84 18.1422 6.77333 18.7378C6.79556 18.7467 6.81778 18.7333 6.83111 18.7111C7.28889 18.0844 7.70222 17.4267 8.06667 16.7422C8.08 16.7156 8.06667 16.6844 8.04 16.6756C7.32444 16.4089 6.64 16.0889 5.98667 15.7289C5.93333 15.6978 5.92889 15.6222 5.98222 15.5822C6.12444 15.4756 6.26222 15.3644 6.39556 15.2533C6.41333 15.2356 6.44 15.2311 6.46222 15.24C10.2933 17 14.7333 17 18.5422 15.24C18.5644 15.2267 18.5867 15.2356 18.6089 15.2533C18.7467 15.3644 18.8844 15.4756 19.0267 15.5822C19.08 15.6222 19.0756 15.6978 19.0222 15.7289C18.3689 16.0844 17.6844 16.7156 16.9644 16.7378C16.9378 16.68 16.9244 16.7111 16.9378 16.7378C17.3022 17.4222 17.7156 18.08 18.1733 18.7067C18.1867 18.7333 18.2089 18.7422 18.2311 18.7333C20.1644 18.1378 22.1244 17.2356 24.1511 15.7511C24.1689 15.7378 24.1822 15.7244 24.1867 15.7067C24.6978 10.48 22.9556 6.04 20.6756 2.18222C20.6667 2.16889 20.6578 2.15556 20.6644 2.15556ZM8.68 12.8711C7.54667 12.8711 6.61333 11.8311 6.61333 10.5511C6.61333 9.27111 7.52889 8.23111 8.68 8.23111C9.84 8.23111 10.7733 9.27111 10.7556 10.5511C10.7556 11.8311 9.84 12.8711 8.68 12.8711ZM16.3244 12.8711C15.1911 12.8711 14.2578 11.8311 14.2578 10.5511C14.2578 9.27111 15.1733 8.23111 16.3244 8.23111C17.4844 8.23111 18.4178 9.27111 18.4 10.5511C18.4 11.8311 17.4844 12.8711 16.3244 12.8711Z"></path></svg>
                    </a>
                </div>
            </li>
            <li class="guild-separator"></li>`;
            
            STATE.guilds.forEach(g => {
                const isActive = STATE.activeGuildId == g.id ? 'active' : '';
                const icon = g.icon_url 
                    ? `<img src="${g.icon_url}" alt="${g.name}" class="guild-icon-img" />`
                    : `<span style="font-size:12px;font-weight:bold;">${g.name.substring(0,2)}</span>`;
                html += `
                <li class="guild-list-item">
                    <div class="guild-blob-item ${isActive}">
                        <div class="guild-pill"></div>
                        <a href="javascript:void(0)" onclick="selectGuild('${g.id}')" class="guild-icon-wrapper" title="${g.name}">
                            ${icon}
                        </a>
                    </div>
                </li>`;
            });
            root.innerHTML = html;
        }

        function renderChannelSidebar(guild) {
            const root = document.getElementById('channels-sidebar-root');
            let channelsHtml = '';
            STATE.channels.forEach((c, index) => {
                channelsHtml += `
                <li class="channel-item stagger-item">
                    <a href="javascript:void(0)" onclick="selectChannel('${c.id}')" class="channel-link">
                        <span class="channel-symbol">#</span>
                        <span class="channel-name">${c.name}</span>
                    </a>
                </li>`;
            });

            root.innerHTML = `
            <div class="sidebar-header"><h1 class="guild-header-name">${guild.name}</h1></div>
            <div class="channels-scroller scroller anim-fade-scale">
                <div class="category-header"><span style="font-size:10px; margin-right:4px;">&#9660;</span><span>文字頻道</span></div>
                <ul class="channel-list-tree" style="list-style:none;padding:0;margin:0;">${channelsHtml}</ul>
            </div>
            ${renderUserBar()}
            `;
        }

        function renderEmptySidebar() {
            document.getElementById('channels-sidebar-root').innerHTML = `
            <div class="sidebar-header"><button style="width:100%;text-align:left;background:#202225;color:#96989d;border:none;border-radius:4px;padding:6px;">尋找或開始對話</button></div>
            <div class="channels-scroller scroller anim-fade-scale">
                <div class="category-header" style="padding: 16px 8px 8px 16px;"><span>儀表板</span></div>
                 <ul class="channel-list-tree" style="list-style:none;padding:0;margin:0;">
                    <li class="channel-item active">
                        <a href="javascript:void(0)" class="channel-link" style="background-color: var(--background-modifier-selected); color: #fff;">
                            <span class="channel-symbol">⚡</span>
                            <span class="channel-name">系統狀態</span>
                        </a>
                    </li>
                </ul>
            </div>
            ${renderUserBar()}`;
        }

        function renderUserBar() {
            if(!STATE.currentUser) return '';
            return `
            <section class="user-bar">
                <div class="user-avatar-wrapper">
                   <img class="user-avatar-img" src="${STATE.currentUser.avatar_url}" alt="avatar">
                   <div class="status-indicator status-online"></div>
                </div>
                <div class="user-info-text">
                    <div class="user-username">${STATE.currentUser.username}</div>
                    <div class="user-discriminator">${STATE.currentUser.discriminator || ''}</div>
                </div>
            </section>`;
        }

        function renderChatInterface(channel) {
            const root = document.getElementById('main-content-root');
            root.innerHTML = `
            <div class="chat-header anim-fade-scale">
                <div class="mobile-menu-btn" id="mobile-menu-trigger">
                    <svg width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"></path></svg>
                </div>
                <span class="hashtag-symbol">#</span>
                <span class="chat-header-title">${channel.name}</span>
                <div style="flex:1;"></div>
                <div style="cursor:pointer;color:#b9bbbe;" id="member-toggle-btn">
                     <svg width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" clip-rule="evenodd" d="M14 8.00598C14 10.211 12.206 12.006 10 12.006C7.795 12.006 6 10.211 6 8.00598C6 5.80098 7.795 4.00598 10 4.00598C12.206 4.00598 14 5.80098 14 8.00598ZM2 19.006C2 15.473 5.29 13.006 10 13.006C14.711 13.006 18 15.473 18 19.006V20.006H2V19.006Z"></path></svg>
                </div>
            </div>
            
            <div class="chat-body anim-fade-scale">
                <div class="messages-wrapper">
                    <div id="msg-list" class="msg-list scroller"></div>
                    <form id="send-form" enctype="multipart/form-data">
                        <div class="channel-textarea">
                            <div class="channel-textarea-inner">
                                <button type="button" id="file-btn" class="attach-button"><span>+</span><input type="file" name="file" id="msg-file" multiple style="display:none;"></button>
                                <textarea name="content" id="msg-content" placeholder="傳送訊息到 #${channel.name}" rows="1"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
            </div>`;
            
            const sidebar = document.getElementById('members-sidebar');
            if (isMembersVisible) sidebar.classList.remove('hidden');
            else sidebar.classList.add('hidden');
            
            setupChatEvents();
        }

        function renderMsg(m) {
            const botTag = m.is_bot ? '<span class="bot-tag">應用</span>' : '';
            let attHtml = '';
            let embedHtml = '';

            if(m.attachments && m.attachments.length > 0) {
                attHtml += '<div class="attachments-grid">';
                m.attachments.forEach(att => {
                    if(att.is_image) {
                        attHtml += `<a href="${att.url}" target="_blank" class="attachment-card"><img src="${att.url}" loading="lazy"></a>`;
                    } else {
                        const ext = att.filename.split('.').pop().toLowerCase();
                        let cls = 'file-type-other';
                        if(['pdf'].includes(ext)) cls = 'file-type-pdf';
                        else if(['zip','rar','7z'].includes(ext)) cls = 'file-type-archive';
                        attHtml += `<a href="${att.url}" target="_blank" class="attachment-card file-card"><div class="file-icon ${cls}">${ext.toUpperCase()}</div><div>${att.filename}</div></a>`;
                    }
                });
                attHtml += '</div>';
            }

            if(m.embeds && m.embeds.length > 0) {
                embedHtml += '<div class="embeds-container">';
                m.embeds.forEach(e => {
                    const img = e.image_url ? `<a href="${e.image_url}" target="_blank"><img class="embed-image" src="${e.image_url}" loading="lazy"></a>` : '';
                    const title = e.title ? `<div class="embed-title">${e.title}</div>` : '';
                    const desc = e.description ? `<div class="embed-desc">${e.description}</div>` : '';
                    embedHtml += `
                    <div class="embed-wrapper">
                        <div class="embed-sidebar"></div>
                        <div class="embed-content">${title}${desc}${img}</div>
                    </div>`;
                });
                embedHtml += '</div>';
            }

            return `
            <div class="msg-container" data-msgid="${m.id}">
                <div class="msg-avatar-wrapper"><img class="msg-avatar" src="${m.avatar_url}" loading="lazy"></div>
                <div class="msg-content">
                    <div class="msg-header">
                        <span class="msg-author">${m.author}</span>${botTag}
                        <span class="msg-timestamp" data-iso="${m.created_at}">${m.created_at}</span>
                    </div>
                    <div class="msg-text">${m.content}</div>
                    ${attHtml}
                    ${embedHtml}
                </div>
            </div>`;
        }

        function renderMembersList(members) {
            const list = document.getElementById('members-list');
            if(!list) return;

            const groups = {};
            const offlineGroup = [];

            members.forEach(m => {
                if (m.status === 'offline') {
                    offlineGroup.push(m);
                } else {
                    const role = m.highest_role_name || "線上";
                    if (!groups[role]) groups[role] = [];
                    groups[role].push(m);
                }
            });

            let html = '';
            
            Object.keys(groups).sort().forEach(role => {
                html += `<div class="member-category">${role} — ${groups[role].length}</div>`;
                groups[role].forEach(m => html += renderMemberItem(m, false));
            });

            if (offlineGroup.length > 0) {
                html += `<div class="member-category">離線 — ${offlineGroup.length}</div>`;
                offlineGroup.forEach(m => html += renderMemberItem(m, true));
            }

            list.innerHTML = html;
        }

        function renderMemberItem(m, isOffline) {
            const statusClass = `status-${m.status}`;
            const opacityClass = isOffline ? 'offline' : '';
            return `
            <div class="member-item stagger-item ${opacityClass}">
                <div class="member-avatar-container">
                    <img class="member-avatar" src="${m.avatar_url}" loading="lazy">
                    ${!isOffline ? `<div class="member-status ${statusClass}"></div>` : ''}
                </div>
                <div class="member-name" style="color:${m.color}">${m.display_name}</div>
            </div>`;
        }

        function setupGlobalEvents() {
            document.body.addEventListener('click', (e) => {
                if (e.target.closest('#mobile-menu-trigger') || e.target.closest('#mobile-menu-trigger-home')) {
                    toggleMobileSidebar(true);
                }
                
                if (e.target.id === 'mobile-overlay') {
                    toggleMobileSidebar(false);
                    isMembersVisible = false;
                    const sb = document.getElementById('members-sidebar');
                    if(sb) sb.classList.add('hidden');
                }
                const toggleBtn = e.target.closest('#member-toggle-btn');
                if (toggleBtn) {
                    isMembersVisible = !isMembersVisible;
                    const sb = document.getElementById('members-sidebar');
                    if(isMembersVisible) sb.classList.remove('hidden');
                    else sb.classList.add('hidden');
                    
                    if(isMembersVisible) toggleBtn.style.color = '#fff';
                    else toggleBtn.style.color = '#b9bbbe';
                }
            });
        }

        function setupChatEvents() {
            const form = document.getElementById('send-form');
            const msgList = document.getElementById('msg-list');
            const ta = document.getElementById('msg-content');
            const fb = document.getElementById('file-btn');

            if(fb) fb.onclick = () => document.getElementById('msg-file').click();

            msgList.addEventListener('scroll', () => {
                if (msgList.scrollTop === 0 && !isLoadingMessages && STATE.activeChannelId) {
                    isLoadingMessages = true;
                    const firstMsg = msgList.querySelector('.msg-container');
                    if (firstMsg) {
                         loadMessages(STATE.activeGuildId, STATE.activeChannelId, firstMsg.dataset.msgid)
                             .finally(() => isLoadingMessages = false);
                    } else isLoadingMessages = false;
                }
            }, { passive: true });

            ta.addEventListener('input', function(){
                this.style.height = 'auto'; this.style.height = this.scrollHeight + 'px';
                if(this.value==='') this.style.height = '22px';
            });
            
            ta.addEventListener('keydown', (e) => {
                if(e.key==='Enter' && !e.shiftKey) { e.preventDefault(); form.dispatchEvent(new Event('submit')); }
            });

            form.onsubmit = async (e) => {
                e.preventDefault();
                if(!ta.value.trim() && !document.getElementById('msg-file').value) return;
                const fd = new FormData(form);
                ta.value = ''; ta.style.height='22px';
                try {
                    await fetch(`${BACKEND_BASE_URL}/api/guild/${STATE.activeGuildId}/channel/${STATE.activeChannelId}/send`, {method:'POST', body:fd});
                } catch(err) { console.error(err); }
            };
        }

        function toggleMobileSidebar(open) {
            const sidebar = document.getElementById('sidebar-container');
            const overlay = document.getElementById('mobile-overlay');
            if (open) {
                sidebar.classList.add('open');
                overlay.classList.add('active');
            } else {
                sidebar.classList.remove('open');
                if (!isMembersVisible) overlay.classList.remove('active');
            }
        }

        function processMessageContent() {
            document.querySelectorAll('.msg-text').forEach(el => {
                if(!el.dataset.processed) {
                    const cleanHtml = DOMPurify.sanitize(marked.parse(el.textContent));
                    el.innerHTML = cleanHtml;
                    el.dataset.processed = "true";
                }
            });
            document.querySelectorAll('pre code').forEach((block) => hljs.highlightElement(block));
            document.querySelectorAll('.msg-timestamp').forEach(el => {
                const iso = el.getAttribute('data-iso');
                if(iso) el.textContent = formatTimestamp(iso);
            });
        }

        function formatTimestamp(isoStr) {
            const date = new Date(isoStr);
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1);
            const msgDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            const timeStr = date.toLocaleTimeString('zh-TW', { hour: 'numeric', minute: '2-digit', hour12: true });

            if (msgDate.getTime() === today.getTime()) return `今天 ${timeStr}`;
            else if (msgDate.getTime() === yesterday.getTime()) return `昨天 ${timeStr}`;
            else return `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()} ${timeStr}`;
        }
    </script>
</body>
</html>
